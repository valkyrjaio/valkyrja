name: Validate Composer

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read

jobs:
  build:

    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: true
      matrix:
        os: [ 'ubuntu-latest' ]
        # os: [ 'ubuntu-latest', 'windows-latest' ]
        php: [ '8.4', '8.5', '8.6' ]
        paths:
          - name: Root
            path: ./
            options: '--strict'
          - name: Churn
            path: .github/ci/churn
            options: '--no-check-publish'
          - name: PHPArkitect
            path: .github/ci/phparkitect
            options: '--no-check-publish'
          - name: PHP Code Sniffer
            path: .github/ci/phpcodesniffer
            options: '--no-check-publish'
          - name: PHP CS Fixer
            path: .github/ci/phpcsfixer
            options: '--no-check-publish'
          - name: PHP Metrics
            path: .github/ci/phpmetrics
            options: '--no-check-publish'
          - name: PHPStan
            path: .github/ci/phparkitect
            options: '--no-check-publish'
          - name: PHPUnit
            path: .github/ci/phpunit
            options: '--no-check-publish'
          - name: Psalm
            path: .github/ci/psalm
            options: '--no-check-publish'
          - name: Rector
            path: .github/ci/rector
            options: '--no-check-publish'
          - name: Suggested Packages
            path: .github/ci/suggested
            options: '--no-check-publish'

    name: ${{ matrix.paths.name }} PHP ${{ matrix.php }} (${{ matrix.os == 'ubuntu-latest' && 'Linux' || 'Windows'  }})

    continue-on-error: ${{ matrix.php == '8.6' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Determine if workflow should run based on files changed
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            composer:
              - '**/composer.*'
              - '.github/workflows/validate-composer.yml'

      - name: Setup PHP
        if: steps.changes.outputs.composer == 'true'
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, intl, sodium, fileinfo

      - name: Validate composer.json
        if: steps.changes.outputs.composer == 'true'
        run: |
          cd ${{ matrix.paths.path }}
          composer validate ${{ matrix.paths.options }}
